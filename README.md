# Sth-Matters: AI代理驱动的知识合成系统

## 1. 项目概述

Sth-Matters 是一个先进的自动化知识工作流系统。用户只需提供一个感兴趣的主题，系统便能模拟人类专家的研究过程，进行多层次的深度信息检索、分析、整合，并最终自动生成多种格式（Markdown, HTML, EPUB）的深度研究报告，通过邮件发送给用户。

本系统的核心设计思想是将复杂的知识处理逻辑委托给一个由详细指令（Prompt）驱动的AI代理，而Python代码则负责提供稳定、健壮的调度、封装和用户交互功能。

## 2. 系统架构

本系统采用分层架构，各层职责分明，清晰地分离了用户交互、任务编排、指令调度和具体执行。

- **表现层 (UI Layer - `main.py` Gradio)**: 提供一个简洁的Web界面，供用户提交研究主题和接收邮箱。这是系统的入口。

- **编排层 (Orchestration Layer - `main.py`)**: 作为系统的“大脑”，接收来自UI的请求，并按顺序调用下层服务（调度层和邮件客户端），以完成整个工作流。

- **调度层 (Dispatch Layer - `rpa.py`)**: 扮演“AI代理调度器”的角色。它将上层传来的简单任务（如一个主题），转换为一条对AI代理来说结构完整、逻辑清晰的复杂指令，并负责调用该AI代理、监控其执行状态。

- **执行层 (Execution Layer - `claude` CLI & `config/ai_prompt.md`)**: 这是真正执行繁重任务的一层。
    - **`claude` CLI**: 一个外部的、强大的命令行AI代理，是所有研究和写作任务的实际执行者。
    - **`config/ai_prompt.md`**: **系统的真正核心逻辑**。这份文件是一份给AI代理的详细“标准作业程序”（SOP），它定义了从研究到成文的每一个步骤。

## 3. 端到端工作流程

1.  **用户请求**: 用户在Gradio界面输入主题和邮箱，点击“开始”按钮。

2.  **任务编排**: `main.py` 接收到请求，调用 `rpa.py` 中的核心方法，并将主题传递过去。

3.  **指令调度**: `rpa.py` 构建一条包含 `config/ai_prompt.md` 指令的命令行，启动 `claude` AI代理。

4.  **AI代理执行**: `claude` 代理启动后，严格遵循 `config/ai_prompt.md` 中定义的四阶段SOP：
    - **阶段1: 初始深度搜索**: 在 `knowledge_base/` 目录中进行多维度的初步信息检索。
    - **阶段2: 概念扩展**: 分析初步结果，提炼关键概念，并围绕这些新概念进行第二轮的扩展搜索，以深化理解。
    - **阶段3: 结果整合**: 合并所有搜索结果，形成一个统一、去重的JSON格式知识索引，并将其保存到 `output/[主题]_索引.json`。
    - **阶段4: 文档生成**: AI代理调用`Bash`工具，依次执行 `src/document_generator/md_generator.py` 和 `src/document_generator/epub_cli.py` 这两个Python脚本，读取上一步生成的JSON索引，创建出所有最终文档。

5.  **结果收集**: `claude` 代理执行完毕后，`rpa.py` 会在 `output/` 目录中找到所有生成的文档，并将其文件路径返回给 `main.py`。

6.  **邮件通知**: `main.py` 调用 `email_client.py`，将这些文档作为附件发送到用户指定的邮箱。

7.  **完成反馈**: `main.py` 在Web界面上向用户显示任务完成的提示。

## 4. 核心组件

- **`src/main.py`**: 系统主入口。包含Gradio Web UI和作为“总指挥”的编排逻辑。
- **`src/rpa.py`**: AI代理调度器。负责封装与 `claude` CLI的交互。
- **`config/ai_prompt.md`**: 系统的“灵魂”。定义了AI代理需要遵循的完整工作流程和研究方法论。
- **`src/document_generator/`**: 包含实际的文档生成脚本，它们是纯粹的工具，根据输入的JSON索引文件工作。
- **`knowledge_base/`**: 系统的知识源泉，所有研究和分析都基于此目录下的内容。
- **`output/`**: 所有由系统生成的中间文件（如JSON索引）和最终文档（.md, .html, .epub）的存放位置。
- **`evaluate.py`**: 一个端到端的集成测试脚本，用于验证整个工作流是否能够顺利运行并产出预期的文件。

## 5. 如何运行

1.  **启动Web服务**:
    ```bash
    python src/main.py
    ```
    执行后，访问 `http://0.0.0.0:7899` 即可打开Web界面。

2.  **运行集成测试**:
    ```bash
    python evaluate.py
    ```
    该命令会以“社会化”为主题，完整地运行一次流程，并检查最终文件是否在 `output/` 目录下正确生成。